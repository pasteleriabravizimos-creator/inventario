<!doctype html>
<html lang="es"> 
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ERP Inventario - BRAVIZIMO'S (Web)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111b2e; --muted:#9fb0d0; --text:#e8f0ff;
      --line:#223257; --accent:#5eead4; --warn:#fbbf24; --crit:#fb7185; --ok:#34d399;
      --btn:#1f2a44; --btn2:#17223a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#070b14,#0b1220);color:var(--text)}
    header{padding:18px 18px 10px; position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:10}
    h1{margin:0;font-size:18px;letter-spacing:.4px}
    .sub{margin-top:6px;color:var(--muted);font-size:12px}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:260px 1fr;gap:12px}
    .card{background:rgba(17,27,46,.92);border:1px solid var(--line);border-radius:14px;padding:12px}
    nav button{width:100%;text-align:left;padding:10px 10px;border-radius:10px;border:1px solid var(--line);background:var(--btn);color:var(--text);cursor:pointer;margin:6px 0}
    nav button.active{outline:2px solid rgba(94,234,212,.35);border-color:rgba(94,234,212,.5)}
    nav button:hover{background:#243353}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0d162a;color:var(--text)}
    textarea{min-height:70px;resize:vertical}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--btn);color:var(--text);cursor:pointer}
    .btn.primary{background:rgba(94,234,212,.14);border-color:rgba(94,234,212,.35)}
    .btn.danger{background:rgba(251,113,133,.12);border-color:rgba(251,113,133,.35)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;border:1px solid var(--line);background:#0d162a;color:var(--muted);font-size:12px}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px}
    .kpi .card{padding:12px}
    .k{font-size:12px;color:var(--muted)}
    .v{font-size:18px;margin-top:6px}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;border:1px solid var(--line)}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:13px}
    th{background:#0d162a;color:var(--muted);text-align:left;position:sticky;top:0}
    tr:last-child td{border-bottom:none}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);display:inline-block}
    .ok{color:var(--ok);border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.08)}
    .min{color:var(--warn);border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.08)}
    .crit{color:var(--crit);border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.08)}
    .muted{color:var(--muted)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .right{margin-left:auto}
    .small{font-size:12px;color:var(--muted)}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}.kpi{grid-template-columns:repeat(2,1fr)}.split{grid-template-columns:1fr}}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="align-items:flex-end">
      <div>
        <h1>ERP Web Inventario ‚Äì BRAVIZIMO‚ÄôS</h1>
        <div class="sub">Productos ‚Ä¢ Kardex ‚Ä¢ Recetas ‚Ä¢ Producci√≥n/Ventas ‚Ä¢ Reporte por categor√≠a ‚Ä¢ Export/Import (JSON)</div>
      </div>
      <div class="right row" style="gap:8px;justify-content:flex-end">
        <button class="btn" id="btnExport">Exportar JSON</button>
        <button class="btn" id="btnImport">Importar JSON</button>
        <button class="btn danger" id="btnReset">Reset</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <nav class="card" id="nav">
      <div class="pill">üì¶ ERP Men√∫</div>
      <button data-view="dashboard" class="active">üìä Dashboard</button>
      <button data-view="productos">üßæ Productos</button>
      <button data-view="kardex">üß± Kardex (Movimientos)</button>
      <button data-view="recetas">üçΩÔ∏è Recetas</button>
      <button data-view="produccion">üë©‚Äçüç≥ Producci√≥n / Ventas</button>
      <button data-view="reportes">üß© Reportes por categor√≠a</button>
      <div class="small" style="margin-top:10px">
        Tips:
        <ul>
          <li>El stock se calcula desde Kardex.</li>
          <li>Ventas/Producci√≥n descuentan insumos por receta.</li>
          <li>Todo se guarda en tu navegador.</li>
        </ul>
      </div>
    </nav>

    <main class="card">
      <div id="view"></div>
    </main>
  </div>
</div>

<input type="file" id="fileImport" accept="application/json" style="display:none" />

<script>
/** ==========================
 *  Mini ERP (localStorage)
 *  ==========================
 *  Datos:
 *   - products: [{id, sku, name, category, unitBase, minStock, cost, price, active}]
 *   - movements: [{id, dateISO, type, productId, qtyBase, note, ref, unitCost}]
 *   - recipes: [{id, productFinalName, lines:[{productId, qtyPerUnit}]}]
 *   - sales: [{id,dateISO, productFinalName, qty, channel, note}]
 *   - productions: [{id,dateISO, productFinalName, qty, note}]
 */

const STORAGE_KEY = "bravizimos_erp_v1";

const TYPES = {
  INGRESO: "INGRESO",
  SALIDA: "SALIDA",
  AJUSTE: "AJUSTE",
  MERMA: "MERMA",
  PRODUCCION: "PRODUCCION",
  VENTA: "VENTA"
};

function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw){
    const init = { products: [], movements: [], recipes: [], sales: [], productions: [] };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
    return init;
  }
  try { return JSON.parse(raw); } catch {
    const init = { products: [], movements: [], recipes: [], sales: [], productions: [] };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
    return init;
  }
}
function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

let state = loadState();

function fmtMoney(n){
  if (n === null || n === undefined || isNaN(n)) return "‚Äî";
  return "S/ " + Number(n).toFixed(2);
}
function fmtQty(n, unit){
  if (n === null || n === undefined || isNaN(n)) return "‚Äî";
  const v = Number(n);
  return (Math.abs(v) >= 1 ? v.toFixed(3).replace(/\.?0+$/,"") : v.toFixed(3)) + " " + (unit||"");
}
function todayISO(){
  const d = new Date();
  d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
  return d.toISOString().slice(0,10);
}
function normalize(s){ return String(s||"").trim().toUpperCase(); }

function getProductById(id){ return state.products.find(p=>p.id===id); }
function productLabel(p){ return `${p.sku} ‚Äî ${p.name}`; }

// Stock = suma qtyBase por productId (INGRESO positivo, SALIDA negativo, etc.)
function stockByProductId(){
  const map = new Map();
  for (const mv of state.movements){
    if (!mv.productId) continue;
    map.set(mv.productId, (map.get(mv.productId)||0) + Number(mv.qtyBase||0));
  }
  return map;
}

function stockStatus(p, stock){
  const min = Number(p.minStock||0);
  if (min <= 0) return {label:"üü¢ Normal", cls:"ok"};
  if (stock <= min) return {label:"üî¥ Cr√≠tico", cls:"crit"};
  if (stock <= min * 1.5) return {label:"üü° M√≠nimo", cls:"min"};
  return {label:"üü¢ Normal", cls:"ok"};
}

function inventoryValue(){
  const stockMap = stockByProductId();
  let costTotal=0, saleTotal=0;
  for (const p of state.products.filter(p=>p.active!==false)){
    const st = stockMap.get(p.id)||0;
    costTotal += st * Number(p.cost||0);
    saleTotal += st * Number(p.price||0);
  }
  return {costTotal, saleTotal};
}

function groupByCategory(){
  const stockMap = stockByProductId();
  const out = {};
  for (const p of state.products.filter(p=>p.active!==false)){
    const cat = p.category || "Sin categor√≠a";
    const st = stockMap.get(p.id)||0;
    if (!out[cat]) out[cat] = {stock:0, cost:0, sale:0, items:0};
    out[cat].stock += st;
    out[cat].cost += st*Number(p.cost||0);
    out[cat].sale += st*Number(p.price||0);
    out[cat].items += 1;
  }
  return out;
}

/** ==========================
 *  Vistas UI
 *  ========================== */
const viewEl = document.getElementById("view");

function setView(name){
  for (const btn of document.querySelectorAll("#nav button")){
    btn.classList.toggle("active", btn.dataset.view === name);
  }
  if (name==="dashboard") renderDashboard();
  if (name==="productos") renderProductos();
  if (name==="kardex") renderKardex();
  if (name==="recetas") renderRecetas();
  if (name==="produccion") renderProduccionVentas();
  if (name==="reportes") renderReportes();
}

document.getElementById("nav").addEventListener("click", (e)=>{
  const b = e.target.closest("button[data-view]");
  if (!b) return;
  setView(b.dataset.view);
});

// Export/Import/Reset
document.getElementById("btnExport").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `ERP_BRAVIZIMOS_${todayISO()}.json`;
  a.click();
});
document.getElementById("btnImport").addEventListener("click", ()=>{
  document.getElementById("fileImport").click();
});
document.getElementById("fileImport").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;
  const txt = await file.text();
  try{
    const obj = JSON.parse(txt);
    if (!obj.products || !obj.movements) throw new Error("Estructura inv√°lida");
    state = obj;
    saveState(state);
    setView("dashboard");
    alert("Importado ‚úÖ");
  }catch(err){
    alert("No se pudo importar: " + err.message);
  }finally{
    e.target.value = "";
  }
});
document.getElementById("btnReset").addEventListener("click", ()=>{
  if (!confirm("¬øSeguro? Se borrar√° todo el ERP en este navegador.")) return;
  state = {products:[], movements:[], recipes:[], sales:[], productions:[]};
  saveState(state);
  setView("dashboard");
});

// ---------- Dashboard ----------
function renderDashboard(){
  const {costTotal, saleTotal} = inventoryValue();
  const stockMap = stockByProductId();

  const active = state.products.filter(p=>p.active!==false);
  let crit=0, min=0;
  for (const p of active){
    const st = stockMap.get(p.id)||0;
    const s = stockStatus(p, st);
    if (s.cls==="crit") crit++;
    if (s.cls==="min") min++;
  }

  viewEl.innerHTML = `
    <div class="kpi">
      <div class="card"><div class="k">Productos activos</div><div class="v">${active.length}</div></div>
      <div class="card"><div class="k">En cr√≠tico</div><div class="v">${crit}</div></div>
      <div class="card"><div class="k">En m√≠nimo</div><div class="v">${min}</div></div>
      <div class="card"><div class="k">Inventario valorizado (costo)</div><div class="v">${fmtMoney(costTotal)}</div></div>
    </div>
    <div style="height:10px"></div>
    <div class="card">
      <div class="row">
        <div class="pill">üìå Acciones r√°pidas</div>
        <button class="btn primary" id="goProd">+ Crear productos</button>
        <button class="btn" id="goIng">+ Registrar ingreso</button>
        <button class="btn" id="goVen">+ Registrar venta</button>
      </div>
      <div class="small" style="margin-top:10px">
        Nota: Para ventas y producci√≥n con descuento autom√°tico, crea la receta en <b>Recetas</b>.
      </div>
    </div>
    <div style="height:10px"></div>
    <div class="card">
      <div class="row">
        <div class="pill">üì¶ Stock bajo (top)</div>
        <div class="right muted">${todayISO()}</div>
      </div>
      <div style="max-height:420px;overflow:auto;margin-top:10px">
        ${renderLowStockTable(stockMap)}
      </div>
    </div>
  `;

  document.getElementById("goProd").onclick=()=>setView("productos");
  document.getElementById("goIng").onclick=()=>{ setView("kardex"); prefillMovementType("INGRESO"); };
  document.getElementById("goVen").onclick=()=>setView("produccion");
}

function renderLowStockTable(stockMap){
  const rows = state.products
    .filter(p=>p.active!==false)
    .map(p=>{
      const st = stockMap.get(p.id)||0;
      const stat = stockStatus(p, st);
      return {p, st, stat};
    })
    .sort((a,b)=> (a.st - b.st));

  if (rows.length===0) return `<div class="muted">A√∫n no hay productos.</div>`;

  const top = rows.slice(0, 20);
  const trs = top.map(({p,st,stat})=>`
    <tr>
      <td>${p.category||"Sin categor√≠a"}</td>
      <td>${productLabel(p)}</td>
      <td>${fmtQty(st, p.unitBase)}</td>
      <td>${fmtMoney(p.cost)}</td>
      <td><span class="tag ${stat.cls}">${stat.label}</span></td>
    </tr>
  `).join("");

  return `
    <table>
      <thead><tr>
        <th>Categor√≠a</th><th>Producto</th><th>Stock</th><th>Costo</th><th>Estado</th>
      </tr></thead>
      <tbody>${trs}</tbody>
    </table>
  `;
}

// ---------- Productos ----------
function renderProductos(){
  viewEl.innerHTML = `
    <div class="row">
      <div class="pill">üßæ Productos</div>
      <div class="right">
        <input id="qProd" placeholder="Buscar producto..." />
      </div>
    </div>

    <div class="split" style="margin-top:10px">
      <div class="card">
        <div class="pill">‚ûï Agregar / Editar</div>
        <div class="row">
          <div>
            <label>SKU (c√≥digo)</label>
            <input id="pSku" placeholder="Ej: QUESO01" />
          </div>
          <div>
            <label>Unidad base</label>
            <select id="pUnit">
              <option value="KG">KG</option>
              <option value="GR">GR</option>
              <option value="UND">UND</option>
              <option value="LT">LT</option>
              <option value="ML">ML</option>
            </select>
          </div>
        </div>
        <label>Producto</label>
        <input id="pName" placeholder="Ej: Queso crema" />
        <label>Categor√≠a</label>
        <input id="pCat" placeholder="Ej: L√°cteos" />
        <div class="row">
          <div>
            <label>Stock m√≠nimo</label>
            <input id="pMin" type="number" step="0.001" placeholder="0" />
          </div>
          <div>
            <label>Costo</label>
            <input id="pCost" type="number" step="0.01" placeholder="0" />
          </div>
          <div>
            <label>Precio venta</label>
            <input id="pPrice" type="number" step="0.01" placeholder="0" />
          </div>
        </div>
        <div class="row">
          <button class="btn primary" id="btnSaveProd">Guardar</button>
          <button class="btn" id="btnClearProd">Limpiar</button>
          <button class="btn danger" id="btnDeleteProd" disabled>Eliminar</button>
        </div>
        <div class="small" id="editHint" style="margin-top:8px">Tip: selecciona un producto de la lista para editar.</div>
      </div>

      <div class="card">
        <div class="pill">üìã Lista</div>
        <div style="max-height:520px;overflow:auto;margin-top:10px" id="prodList"></div>
      </div>
    </div>
  `;

  const prodList = document.getElementById("prodList");
  const qProd = document.getElementById("qProd");

  let editingId = null;

  function refreshList(){
    const stockMap = stockByProductId();
    const q = normalize(qProd.value);
    const items = state.products
      .filter(p => (p.active!==false))
      .filter(p => !q || normalize(p.name).includes(q) || normalize(p.sku).includes(q) || normalize(p.category).includes(q))
      .sort((a,b)=> a.category.localeCompare(b.category) || a.name.localeCompare(b.name));

    if (items.length===0){
      prodList.innerHTML = `<div class="muted">Sin productos. Agrega uno.</div>`;
      return;
    }

    prodList.innerHTML = `
      <table>
        <thead><tr>
          <th>Categor√≠a</th><th>SKU</th><th>Producto</th><th>Stock</th><th>Estado</th>
        </tr></thead>
        <tbody>
          ${items.map(p=>{
            const st = stockMap.get(p.id)||0;
            const s = stockStatus(p, st);
            return `
              <tr data-id="${p.id}" style="cursor:pointer">
                <td>${p.category||"Sin categor√≠a"}</td>
                <td>${p.sku||""}</td>
                <td>${p.name}</td>
                <td>${fmtQty(st,p.unitBase)}</td>
                <td><span class="tag ${s.cls}">${s.label}</span></td>
              </tr>`;
          }).join("")}
        </tbody>
      </table>
    `;
  }

  function fillForm(p){
    editingId = p.id;
    document.getElementById("pSku").value = p.sku||"";
    document.getElementById("pName").value = p.name||"";
    document.getElementById("pCat").value = p.category||"";
    document.getElementById("pUnit").value = p.unitBase||"KG";
    document.getElementById("pMin").value = p.minStock ?? 0;
    document.getElementById("pCost").value = p.cost ?? 0;
    document.getElementById("pPrice").value = p.price ?? 0;
    document.getElementById("btnDeleteProd").disabled = false;
    document.getElementById("editHint").textContent = "Editando: " + productLabel(p);
  }

  prodList.addEventListener("click",(e)=>{
    const tr = e.target.closest("tr[data-id]");
    if (!tr) return;
    const p = getProductById(tr.dataset.id);
    if (p) fillForm(p);
  });

  document.getElementById("btnClearProd").onclick=()=>{
    editingId=null;
    ["pSku","pName","pCat","pMin","pCost","pPrice"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("pUnit").value="KG";
    document.getElementById("btnDeleteProd").disabled=true;
    document.getElementById("editHint").textContent="Tip: selecciona un producto de la lista para editar.";
  };

  document.getElementById("btnSaveProd").onclick=()=>{
    const sku = document.getElementById("pSku").value.trim();
    const name = document.getElementById("pName").value.trim();
    const category = document.getElementById("pCat").value.trim();
    const unitBase = document.getElementById("pUnit").value;
    const minStock = Number(document.getElementById("pMin").value||0);
    const cost = Number(document.getElementById("pCost").value||0);
    const price = Number(document.getElementById("pPrice").value||0);

    if (!sku || !name){
      alert("SKU y Producto son obligatorios.");
      return;
    }

    // SKU √∫nico
    const exists = state.products.find(p=>p.sku===sku && p.id!==editingId);
    if (exists){ alert("SKU ya existe. Usa otro."); return; }

    if (editingId){
      const p = getProductById(editingId);
      Object.assign(p, {sku,name,category,unitBase,minStock,cost,price,active:true});
    }else{
      state.products.push({id:uid(), sku, name, category, unitBase, minStock, cost, price, active:true});
    }
    saveState(state);
    refreshList();
    alert("Guardado ‚úÖ");
  };

  document.getElementById("btnDeleteProd").onclick=()=>{
    if (!editingId) return;
    if (!confirm("¬øEliminar producto? (se mantiene historial en Kardex, pero el producto quedar√° inactivo)")) return;
    const p = getProductById(editingId);
    p.active = false;
    saveState(state);
    editingId=null;
    document.getElementById("btnClearProd").click();
    refreshList();
  };

  qProd.oninput=refreshList;
  refreshList();
}

// ---------- Kardex ----------
let lastPrefillType = null;
function prefillMovementType(t){ lastPrefillType = t; }

function renderKardex(){
  const products = state.products.filter(p=>p.active!==false).sort((a,b)=>a.name.localeCompare(b.name));
  const stockMap = stockByProductId();

  viewEl.innerHTML = `
    <div class="row">
      <div class="pill">üß± Kardex (Movimientos)</div>
      <div class="right row" style="gap:8px;justify-content:flex-end">
        <input id="qK" placeholder="Buscar en kardex..." style="max-width:280px" />
      </div>
    </div>

    <div class="split" style="margin-top:10px">
      <div class="card">
        <div class="pill">‚ûï Registrar movimiento</div>
        <div class="row">
          <div>
            <label>Fecha</label>
            <input id="mvDate" type="date" value="${todayISO()}" />
          </div>
          <div>
            <label>Tipo</label>
            <select id="mvType">
              <option value="${TYPES.INGRESO}">INGRESO (compra)</option>
              <option value="${TYPES.SALIDA}">SALIDA (uso)</option>
              <option value="${TYPES.MERMA}">MERMA</option>
              <option value="${TYPES.AJUSTE}">AJUSTE (+/-)</option>
            </select>
          </div>
        </div>

        <label>Producto</label>
        <select id="mvProd">
          <option value="">‚Äî Selecciona ‚Äî</option>
          ${products.map(p=>`<option value="${p.id}">${productLabel(p)}</option>`).join("")}
        </select>

        <div class="row">
          <div>
            <label>Cantidad (en unidad base)</label>
            <input id="mvQty" type="number" step="0.001" placeholder="Ej: 2.5" />
            <div class="small" id="mvUnitHint"></div>
          </div>
          <div>
            <label>Costo unitario (opcional)</label>
            <input id="mvCost" type="number" step="0.01" placeholder="Ej: 12.50" />
          </div>
        </div>

        <label>Nota</label>
        <textarea id="mvNote" placeholder="Proveedor, motivo, etc."></textarea>
        <div class="row">
          <button class="btn primary" id="btnAddMv">Registrar</button>
          <button class="btn" id="btnQuickIngreso">Ingreso r√°pido</button>
          <button class="btn" id="btnQuickSalida">Salida r√°pida</button>
        </div>

        <div class="small" style="margin-top:8px">
          Regla: INGRESO suma, SALIDA/MERMA restan. AJUSTE permite + o - seg√∫n la cantidad.
        </div>
      </div>

      <div class="card">
        <div class="pill">üìú Historial</div>
        <div style="max-height:520px;overflow:auto;margin-top:10px" id="kList"></div>
      </div>
    </div>
  `;

  const mvType = document.getElementById("mvType");
  if (lastPrefillType && Object.values(TYPES).includes(lastPrefillType)) {
    mvType.value = lastPrefillType;
    lastPrefillType = null;
  }

  const mvProd = document.getElementById("mvProd");
  const mvUnitHint = document.getElementById("mvUnitHint");

  mvProd.onchange=()=>{
    const p = getProductById(mvProd.value);
    mvUnitHint.textContent = p ? `Unidad base: ${p.unitBase} | Stock actual: ${fmtQty(stockMap.get(p.id)||0, p.unitBase)}` : "";
  };

  function refreshKList(){
    const q = normalize(document.getElementById("qK").value);
    const rows = [...state.movements].sort((a,b)=> (b.dateISO||"").localeCompare(a.dateISO||""));

    const filtered = rows.filter(m=>{
      const p = m.productId ? getProductById(m.productId) : null;
      const txt = `${m.type} ${m.note||""} ${m.ref||""} ${(p?.name)||""} ${(p?.sku)||""}`;
      return !q || normalize(txt).includes(q);
    });

    const trs = filtered.slice(0,500).map(m=>{
      const p = m.productId ? getProductById(m.productId) : null;
      const qty = Number(m.qtyBase||0);
      const isNeg = qty < 0;
      return `
        <tr>
          <td>${m.dateISO||""}</td>
          <td>${m.type}</td>
          <td>${p ? productLabel(p) : "<span class='muted'>‚Äî</span>"}</td>
          <td>${isNeg ? `<span class="crit">${fmtQty(qty, p?.unitBase||"")}</span>` : `<span class="ok">${fmtQty(qty, p?.unitBase||"")}</span>`}</td>
          <td class="muted">${m.note||""}</td>
        </tr>`;
    }).join("");

    document.getElementById("kList").innerHTML = `
      <table>
        <thead><tr><th>Fecha</th><th>Tipo</th><th>Producto</th><th>Cantidad</th><th>Nota</th></tr></thead>
        <tbody>${trs || `<tr><td colspan="5" class="muted">Sin movimientos.</td></tr>`}</tbody>
      </table>
    `;
  }

  document.getElementById("btnAddMv").onclick=()=>{
    const dateISO = document.getElementById("mvDate").value || todayISO();
    const type = mvType.value;
    const productId = mvProd.value;
    const qty = Number(document.getElementById("mvQty").value||0);
    const note = document.getElementById("mvNote").value.trim();
    const unitCost = Number(document.getElementById("mvCost").value||0);

    if (!productId){ alert("Selecciona producto."); return; }
    if (!qty){ alert("Cantidad inv√°lida."); return; }

    let qtyBase = qty;
    if (type===TYPES.SALIDA || type===TYPES.MERMA){
      qtyBase = -Math.abs(qty);
    } else if (type===TYPES.INGRESO){
      qtyBase = Math.abs(qty);
    } // AJUSTE: se respeta signo que ponga el usuario

    state.movements.push({id:uid(), dateISO, type, productId, qtyBase, note, ref:"", unitCost: unitCost||null});
    saveState(state);
    refreshKList();
    alert("Movimiento registrado ‚úÖ");
  };

  document.getElementById("btnQuickIngreso").onclick=()=>mvType.value=TYPES.INGRESO;
  document.getElementById("btnQuickSalida").onclick=()=>mvType.value=TYPES.SALIDA;

  document.getElementById("qK").oninput=refreshKList;
  refreshKList();
};

// ---------- Recetas ----------
function renderRecetas(){
  const products = state.products.filter(p=>p.active!==false).sort((a,b)=>a.name.localeCompare(b.name));

  viewEl.innerHTML = `
    <div class="row">
      <div class="pill">üçΩÔ∏è Recetas</div>
      <div class="right muted">Las recetas permiten descontar insumos autom√°ticamente.</div>
    </div>

    <div class="split" style="margin-top:10px">
      <div class="card">
        <div class="pill">‚ûï Crear / Editar receta</div>
        <label>Producto final (nombre)</label>
        <input id="rfName" placeholder="Ej: Empanada de jam√≥n y queso" />
        <div class="row">
          <div>
            <label>Insumo</label>
            <select id="rfProd">
              <option value="">‚Äî Selecciona insumo ‚Äî</option>
              ${products.map(p=>`<option value="${p.id}">${productLabel(p)} (${p.unitBase})</option>`).join("")}
            </select>
          </div>
          <div>
            <label>Cantidad por 1 unidad final (en unidad base del insumo)</label>
            <input id="rfQty" type="number" step="0.001" placeholder="Ej: 0.03" />
          </div>
        </div>
        <div class="row">
          <button class="btn" id="btnAddLine">Agregar insumo</button>
          <button class="btn primary" id="btnSaveRecipe">Guardar receta</button>
          <button class="btn danger" id="btnDelRecipe" disabled>Eliminar receta</button>
        </div>
        <div class="small" style="margin-top:8px">
          Ejemplo: Si Queso crema (KG) usa 0.03 por empanada, al vender 10 se descuenta 0.30 KG.
        </div>
        <div style="margin-top:10px" id="rfLines"></div>
      </div>

      <div class="card">
        <div class="pill">üìã Recetas guardadas</div>
        <div style="max-height:520px;overflow:auto;margin-top:10px" id="rList"></div>
      </div>
    </div>
  `;

  let editingRecipeId = null;
  let draftLines = [];

  const rfLines = document.getElementById("rfLines");

  function renderLines(){
    if (draftLines.length===0){
      rfLines.innerHTML = `<div class="muted">A√∫n no agregas insumos.</div>`;
      return;
    }
    rfLines.innerHTML = `
      <table>
        <thead><tr><th>Insumo</th><th>Cant. por unidad</th><th></th></tr></thead>
        <tbody>
          ${draftLines.map((l,idx)=>{
            const p = getProductById(l.productId);
            return `
              <tr>
                <td>${p ? productLabel(p) : "‚Äî"}</td>
                <td>${fmtQty(l.qtyPerUnit, p?.unitBase||"")}</td>
                <td><button class="btn danger" data-del="${idx}">Quitar</button></td>
              </tr>`;
          }).join("")}
        </tbody>
      </table>
    `;
  }

  rfLines.addEventListener("click",(e)=>{
    const b = e.target.closest("button[data-del]");
    if (!b) return;
    draftLines.splice(Number(b.dataset.del),1);
    renderLines();
  });

  document.getElementById("btnAddLine").onclick=()=>{
    const productId = document.getElementById("rfProd").value;
    const qtyPerUnit = Number(document.getElementById("rfQty").value||0);
    if (!productId){ alert("Selecciona insumo."); return; }
    if (!qtyPerUnit){ alert("Cantidad inv√°lida."); return; }
    draftLines.push({productId, qtyPerUnit});
    document.getElementById("rfQty").value="";
    renderLines();
  };

  function refreshRecipeList(){
    const items = [...state.recipes].sort((a,b)=> a.productFinalName.localeCompare(b.productFinalName));
    const el = document.getElementById("rList");
    if (items.length===0){
      el.innerHTML = `<div class="muted">Sin recetas a√∫n.</div>`;
      return;
    }
    el.innerHTML = `
      <table>
        <thead><tr><th>Producto final</th><th>Insumos</th></tr></thead>
        <tbody>
          ${items.map(r=>`
            <tr data-id="${r.id}" style="cursor:pointer">
              <td>${r.productFinalName}</td>
              <td class="muted">${r.lines.length}</td>
            </tr>`).join("")}
        </tbody>
      </table>
    `;
  }

  document.getElementById("rList").addEventListener("click",(e)=>{
    const tr = e.target.closest("tr[data-id]");
    if (!tr) return;
    const r = state.recipes.find(x=>x.id===tr.dataset.id);
    if (!r) return;

    editingRecipeId = r.id;
    document.getElementById("rfName").value = r.productFinalName;
    draftLines = r.lines.map(x=>({...x}));
    document.getElementById("btnDelRecipe").disabled = false;
    renderLines();
  });

  document.getElementById("btnSaveRecipe").onclick=()=>{
    const productFinalName = document.getElementById("rfName").value.trim();
    if (!productFinalName){ alert("Nombre de producto final requerido."); return; }
    if (draftLines.length===0){ alert("Agrega al menos 1 insumo."); return; }

    if (editingRecipeId){
      const r = state.recipes.find(x=>x.id===editingRecipeId);
      r.productFinalName = productFinalName;
      r.lines = draftLines;
    } else {
      state.recipes.push({id:uid(), productFinalName, lines:draftLines});
    }
    saveState(state);
    refreshRecipeList();
    alert("Receta guardada ‚úÖ");
  };

  document.getElementById("btnDelRecipe").onclick=()=>{
    if (!editingRecipeId) return;
    if (!confirm("¬øEliminar receta?")) return;
    state.recipes = state.recipes.filter(r=>r.id!==editingRecipeId);
    saveState(state);
    editingRecipeId=null;
    draftLines=[];
    document.getElementById("rfName").value="";
    document.getElementById("btnDelRecipe").disabled=true;
    renderLines();
    refreshRecipeList();
  };

  renderLines();
  refreshRecipeList();
}

// ---------- Producci√≥n y Ventas ----------
function renderProduccionVentas(){
  const recipeNames = state.recipes.map(r=>r.productFinalName).sort((a,b)=>a.localeCompare(b));
  viewEl.innerHTML = `
    <div class="row">
      <div class="pill">üë©‚Äçüç≥ Producci√≥n / üí≥ Ventas</div>
      <div class="right muted">Se descuenta insumo seg√∫n receta.</div>
    </div>

    <div class="split" style="margin-top:10px">
      <div class="card">
        <div class="pill">Producci√≥n</div>
        <div class="row">
          <div>
            <label>Fecha</label>
            <input id="prDate" type="date" value="${todayISO()}" />
          </div>
          <div>
            <label>Producto final</label>
            <select id="prName">
              <option value="">‚Äî Selecciona receta ‚Äî</option>
              ${recipeNames.map(n=>`<option value="${n}">${n}</option>`).join("")}
            </select>
          </div>
          <div>
            <label>Cantidad producida</label>
            <input id="prQty" type="number" step="1" placeholder="Ej: 10" />
          </div>
        </div>
        <label>Nota</label>
        <textarea id="prNote" placeholder="Turno, responsable, etc."></textarea>
        <button class="btn primary" id="btnDoProd">Registrar producci√≥n (descontar)</button>
        <div class="small" style="margin-top:8px" id="prPreview"></div>
      </div>

      <div class="card">
        <div class="pill">Ventas</div>
        <div class="row">
          <div>
            <label>Fecha</label>
            <input id="svDate" type="date" value="${todayISO()}" />
          </div>
          <div>
            <label>Producto vendido</label>
            <select id="svName">
              <option value="">‚Äî Selecciona receta ‚Äî</option>
              ${recipeNames.map(n=>`<option value="${n}">${n}</option>`).join("")}
            </select>
          </div>
          <div>
            <label>Cantidad vendida</label>
            <input id="svQty" type="number" step="1" placeholder="Ej: 5" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Canal</label>
            <select id="svChannel">
              <option value="MOSTRADOR">MOSTRADOR</option>
              <option value="DELIVERY">DELIVERY</option>
              <option value="EVENTO">EVENTO</option>
              <option value="OTRO">OTRO</option>
            </select>
          </div>
        </div>
        <label>Nota</label>
        <textarea id="svNote" placeholder="Boleta, cliente, etc."></textarea>
        <button class="btn primary" id="btnDoSale">Registrar venta (descontar)</button>
        <div class="small" style="margin-top:8px" id="svPreview"></div>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="card">
      <div class="pill">üìú √öltimos registros</div>
      <div style="max-height:420px;overflow:auto;margin-top:10px" id="pvLog"></div>
    </div>
  `;

  function getRecipeByName(name){
    return state.recipes.find(r=>r.productFinalName===name);
  }
  function recipePreview(name, qty){
    const r = getRecipeByName(name);
    if (!r) return "";
    const n = Number(qty||0);
    if (!n) return "Selecciona receta y cantidad para ver el consumo.";
    const lines = r.lines.map(l=>{
      const p = getProductById(l.productId);
      const need = Number(l.qtyPerUnit||0)*n;
      return `‚Ä¢ ${p ? p.name : "Insumo"}: ${fmtQty(need, p?.unitBase||"")}`;
    }).join("<br/>");
    return `<div class="muted">Consumo estimado:</div><div style="margin-top:6px">${lines}</div>`;
  }

  const prName = document.getElementById("prName");
  const prQty = document.getElementById("prQty");
  const prPreview = document.getElementById("prPreview");
  const svName = document.getElementById("svName");
  const svQty = document.getElementById("svQty");
  const svPreview = document.getElementById("svPreview");

  function updatePreviews(){
    prPreview.innerHTML = recipePreview(prName.value, prQty.value);
    svPreview.innerHTML = recipePreview(svName.value, svQty.value);
  }
  prName.onchange=updatePreviews; prQty.oninput=updatePreviews;
  svName.onchange=updatePreviews; svQty.oninput=updatePreviews;
  updatePreviews();

  function applyRecipeMovement(type, dateISO, finalName, qty, note, extra){
    const r = getRecipeByName(finalName);
    if (!r) throw new Error("No existe receta.");
    const n = Number(qty||0);
    if (!n) throw new Error("Cantidad inv√°lida.");

    // registra evento (log)
    if (type===TYPES.VENTA) state.sales.push({id:uid(), dateISO, productFinalName:finalName, qty:n, channel:extra?.channel||"", note});
    if (type===TYPES.PRODUCCION) state.productions.push({id:uid(), dateISO, productFinalName:finalName, qty:n, note});

    // descuenta insumos
    for (const l of r.lines){
      const p = getProductById(l.productId);
      const consume = Number(l.qtyPerUnit||0)*n;
      if (!consume) continue;
      state.movements.push({
        id: uid(),
        dateISO,
        type,
        productId: l.productId,
        qtyBase: -Math.abs(consume),
        note: `${type}: ${finalName} x ${n}. ${note||""}`.trim(),
        ref: extra?.channel ? `Canal:${extra.channel}` : "",
        unitCost: p?.cost ?? null
      });
    }
  }

  document.getElementById("btnDoProd").onclick=()=>{
    try{
      const dateISO = document.getElementById("prDate").value || todayISO();
      const finalName = document.getElementById("prName").value;
      const qty = document.getElementById("prQty").value;
      const note = document.getElementById("prNote").value.trim();
      if (!finalName) return alert("Selecciona receta (producto final).");
      applyRecipeMovement(TYPES.PRODUCCION, dateISO, finalName, qty, note, {});
      saveState(state);
      alert("Producci√≥n registrada ‚úÖ (insumos descontados)");
      renderProduccionVentas();
    }catch(e){ alert(e.message); }
  };

  document.getElementById("btnDoSale").onclick=()=>{
    try{
      const dateISO = document.getElementById("svDate").value || todayISO();
      const finalName = document.getElementById("svName").value;
      const qty = document.getElementById("svQty").value;
      const note = document.getElementById("svNote").value.trim();
      const channel = document.getElementById("svChannel").value;
      if (!finalName) return alert("Selecciona receta (producto vendido).");
      applyRecipeMovement(TYPES.VENTA, dateISO, finalName, qty, note, {channel});
      saveState(state);
      alert("Venta registrada ‚úÖ (insumos descontados)");
      renderProduccionVentas();
    }catch(e){ alert(e.message); }
  };

  // Log
  function renderLog(){
    const logs = [
      ...state.productions.map(x=>({t:"PRODUCCION",...x})),
      ...state.sales.map(x=>({t:"VENTA",...x}))
    ].sort((a,b)=> (b.dateISO||"").localeCompare(a.dateISO||"")).slice(0,60);

    document.getElementById("pvLog").innerHTML = `
      <table>
        <thead><tr><th>Fecha</th><th>Tipo</th><th>Producto</th><th>Cant.</th><th>Detalle</th></tr></thead>
        <tbody>
          ${logs.map(x=>`
            <tr>
              <td>${x.dateISO||""}</td>
              <td>${x.t}</td>
              <td>${x.productFinalName}</td>
              <td>${x.qty}</td>
              <td class="muted">${x.channel ? ("Canal: "+x.channel+" | ") : ""}${x.note||""}</td>
            </tr>`).join("") || `<tr><td colspan="5" class="muted">Sin registros a√∫n.</td></tr>`}
        </tbody>
      </table>
    `;
  }
  renderLog();
}

// ---------- Reportes ----------
function renderReportes(){
  const byCat = groupByCategory();
  const cats = Object.keys(byCat).sort((a,b)=>a.localeCompare(b));

  const rows = cats.map(c=>{
    const x = byCat[c];
    return `
      <tr>
        <td>${c}</td>
        <td>${x.items}</td>
        <td>${x.stock.toFixed(3).replace(/\.?0+$/,"")}</td>
        <td>${fmtMoney(x.cost)}</td>
        <td>${fmtMoney(x.sale)}</td>
      </tr>
    `;
  }).join("");

  viewEl.innerHTML = `
    <div class="row">
      <div class="pill">üß© Reportes por categor√≠a</div>
      <div class="right muted">Valorizaci√≥n a costo y a precio de venta.</div>
    </div>

    <div style="height:10px"></div>

    <div class="card">
      <div class="pill">Resumen</div>
      <div style="max-height:520px;overflow:auto;margin-top:10px">
        <table>
          <thead><tr>
            <th>Categor√≠a</th><th># Productos</th><th>Stock (suma)</th><th>Valor costo</th><th>Valor venta</th>
          </tr></thead>
          <tbody>
            ${rows || `<tr><td colspan="5" class="muted">Sin datos.</td></tr>`}
          </tbody>
        </table>
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="card">
      <div class="pill">Detalle (productos)</div>
      <div style="max-height:520px;overflow:auto;margin-top:10px">
        ${renderProductsDetailTable()}
      </div>
    </div>
  `;
}

function renderProductsDetailTable(){
  const stockMap = stockByProductId();
  const items = state.products
    .filter(p=>p.active!==false)
    .map(p=>{
      const st = stockMap.get(p.id)||0;
      const s = stockStatus(p, st);
      return {p, st, s};
    })
    .sort((a,b)=> (a.p.category||"").localeCompare(b.p.category||"") || a.p.name.localeCompare(b.p.name));

  if (items.length===0) return `<div class="muted">Sin productos.</div>`;

  return `
    <table>
      <thead><tr>
        <th>Categor√≠a</th><th>SKU</th><th>Producto</th><th>Unidad</th>
        <th>Stock</th><th>M√≠nimo</th><th>Costo</th><th>Precio</th><th>Estado</th>
      </tr></thead>
      <tbody>
        ${items.map(({p,st,s})=>`
          <tr>
            <td>${p.category||"Sin categor√≠a"}</td>
            <td>${p.sku||""}</td>
            <td>${p.name}</td>
            <td>${p.unitBase||""}</td>
            <td>${fmtQty(st,p.unitBase)}</td>
            <td>${fmtQty(Number(p.minStock||0), p.unitBase)}</td>
            <td>${fmtMoney(p.cost)}</td>
            <td>${fmtMoney(p.price)}</td>
            <td><span class="tag ${s.cls}">${s.label}</span></td>
          </tr>`).join("")}
      </tbody>
    </table>
  `;
}

// Inicial
setView("dashboard");
</script>
</body>
</html>
