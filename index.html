<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ERP Inventario ‚Äì BRAVIZIMO‚ÄôS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Librer√≠as -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
 --bg:#0b1220;--card:#131c33;--line:#1f2a44;--text:#e8f0ff;
 --accent:#5eead4;--warn:#fbbf24;--crit:#fb7185;
}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI;background:var(--bg);color:var(--text)}
header{display:flex;align-items:center;gap:12px;padding:14px 20px;background:#0e1628;border-bottom:1px solid var(--line)}
header img{height:36px}
.wrap{display:flex;height:calc(100vh - 64px)}
nav{width:260px;background:#0e1628;border-right:1px solid var(--line);padding:12px}
nav button{width:100%;margin:6px 0;padding:10px;border-radius:8px;border:1px solid var(--line);background:#131c33;color:var(--text);cursor:pointer}
nav button.active{border-color:var(--accent)}
main{flex:1;padding:16px;overflow:auto}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:14px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--line);font-size:13px}
th{text-align:left;color:#94a3b8}
input,select,button{background:#0b1220;color:var(--text);border:1px solid var(--line);border-radius:6px;padding:6px}
button.primary{background:#0f766e;border-color:#0f766e}
.badge.ok{color:#22c55e}
.badge.warn{color:#fbbf24}
.badge.crit{color:#fb7185}
</style>
</head>

<body>

<header>
  <img src="logo.png" alt="Bravizimo's">
  <h2>ERP Inventario ‚Äì BRAVIZIMO‚ÄôS</h2>
</header>

<div class="wrap">
  <nav id="menu"></nav>
  <main id="content"></main>
</div>

<script>
// ======================= BASE DE DATOS =======================
const DB = {
 insumos: JSON.parse(localStorage.getItem("insumos")||"[]"),
 productos: JSON.parse(localStorage.getItem("productos")||"[]"),
 recetas: JSON.parse(localStorage.getItem("recetas")||"[]"),
 packs: JSON.parse(localStorage.getItem("packs")||"[]"),
 produccion: JSON.parse(localStorage.getItem("produccion")||"[]"),
 kardex: JSON.parse(localStorage.getItem("kardex")||"[]"),
 rol: localStorage.getItem("rol") || "ADMIN"
};
function save(){
 Object.keys(DB).forEach(k=>{
  if(k!=="rol") localStorage.setItem(k,JSON.stringify(DB[k]));
 });
}

// ======================= MENU =======================
function renderMenu(){
 document.getElementById("menu").innerHTML=`
 <button onclick="dashboard()">üìä Dashboard</button>
 <button onclick="insumos()">üì¶ Insumos</button>
 ${DB.rol==="ADMIN"?`
 <button onclick="productos()">üí≤ Productos</button>
 <button onclick="recetasView()">üìñ Recetas & Packs</button>
 <button onclick="produccionView()">üë©‚Äçüç≥ Producci√≥n / Ventas</button>
 <button onclick="reportes()">üìÜ Reportes</button>
 <button onclick="importBase()">‚¨Ü Importar Base Excel</button>
 <button onclick="importProduccion()">‚¨Ü Importar Producci√≥n</button>
 `:""}
 <button onclick="kardexView()">üìí Kardex</button>
 `;
}
renderMenu();

// ======================= DASHBOARD =======================
function dashboard(){
 const total = DB.insumos.reduce((s,i)=>s+(i.stock*i.costo),0);
 document.getElementById("content").innerHTML=`
 <div class="grid">
  <div class="card"><h3>Inventario valorizado</h3><h2>S/ ${total.toFixed(2)}</h2></div>
  <div class="card"><h3>Insumos</h3><h2>${DB.insumos.length}</h2></div>
  <div class="card"><h3>Producciones</h3><h2>${DB.produccion.length}</h2></div>
 </div>
 <div class="card"><canvas id="chart"></canvas></div>`;
 const ctx=document.getElementById("chart");
 new Chart(ctx,{
  type:"bar",
  data:{
   labels:DB.insumos.map(i=>i.nombre),
   datasets:[{label:"Valor S/",data:DB.insumos.map(i=>i.stock*i.costo),backgroundColor:"#5eead4"}]
  }
 });
}

// ======================= INSUMOS =======================
function insumos(){
 let rows=DB.insumos.map(i=>{
  let estado=i.stock<=0?"crit":i.stock<i.min?"warn":"ok";
  return `<tr>
   <td>${i.categoria||"INSUMOS"}</td>
   <td>${i.nombre}</td>
   <td>${i.stock}</td>
   <td>S/ ${i.costo}</td>
   <td><span class="badge ${estado}">${estado.toUpperCase()}</span></td>
  </tr>`;
 }).join("");
 document.getElementById("content").innerHTML=`
 <div class="card">
 <h3>Insumos</h3>
 <table>
 <tr><th>Categor√≠a</th><th>Insumo</th><th>Stock</th><th>Costo</th><th>Estado</th></tr>
 ${rows}
 </table>
 </div>`;
}

// ======================= PRODUCCI√ìN =======================
function produccionView(){
 document.getElementById("content").innerHTML=`
 <div class="card">
 <h3>Registrar Producci√≥n / Venta</h3>
 <input id="pProd" placeholder="Producto o Pack">
 <input id="pCant" type="number" placeholder="Cantidad">
 <button class="primary" onclick="guardarProduccion()">Registrar</button>
 </div>`;
}

function guardarProduccion(){
 const prod=document.getElementById("pProd").value;
 const cant=+document.getElementById("pCant").value;
 const fecha=new Date().toISOString().slice(0,10);

 let costoTotal=0;
 DB.recetas.filter(r=>r.producto===prod).forEach(r=>{
  const ins=DB.insumos.find(i=>i.nombre===r.insumo);
  if(ins){
   const q=r.cantidad*cant;
   ins.stock-=q;
   costoTotal+=q*ins.costo;
   DB.kardex.push({fecha,tipo:"PRODUCCI√ìN",insumo:ins.nombre,cantidad:-q});
  }
 });

 DB.produccion.push({fecha,producto:prod,cantidad:cant,costo:costoTotal});
 save(); alert("Producci√≥n registrada");
}

// ======================= KARDEX =======================
function kardexView(){
 let rows=DB.kardex.map(k=>`
 <tr><td>${k.fecha}</td><td>${k.tipo}</td><td>${k.insumo}</td><td>${k.cantidad}</td></tr>
 `).join("");
 document.getElementById("content").innerHTML=`
 <div class="card">
 <h3>Kardex</h3>
 <table>
 <tr><th>Fecha</th><th>Tipo</th><th>Insumo</th><th>Cantidad</th></tr>
 ${rows}
 </table>
 </div>`;
}

// ======================= REPORTES =======================
function reportes(){
 let rows=DB.produccion.map(p=>`
 <tr><td>${p.fecha}</td><td>${p.producto}</td><td>${p.cantidad}</td><td>S/ ${p.costo.toFixed(2)}</td></tr>
 `).join("");
 document.getElementById("content").innerHTML=`
 <div class="card">
 <h3>Producci√≥n por fecha</h3>
 <table>
 <tr><th>Fecha</th><th>Producto</th><th>Cantidad</th><th>Costo</th></tr>
 ${rows}
 </table>
 </div>`;
}

// ======================= IMPORTACI√ìN EXCEL =======================
function importBase(){openFile(true)}
function importProduccion(){openFile(false)}

function openFile(isBase){
 const input=document.createElement("input");
 input.type="file";
 input.accept=".xlsx";
 input.onchange=e=>readExcel(e.target.files[0],isBase);
 input.click();
}

function readExcel(file,isBase){
 const reader=new FileReader();
 reader.onload=e=>{
  const wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
  if(isBase){
   loadInsumos(wb);loadProductos(wb);loadRecetas(wb);loadPacks(wb);
   alert("Base importada correctamente");
  }else{
   loadProduccion(wb);
   alert("Producci√≥n importada correctamente");
  }
  save();dashboard();
 };
 reader.readAsArrayBuffer(file);
}

// ======================= LOADERS =======================
function loadInsumos(wb){
 const sh=wb.Sheets["insumos"]; if(!sh) return;
 XLSX.utils.sheet_to_json(sh).forEach(r=>{
  DB.insumos.push({
   nombre:r.Ingrediente,
   unidad:r.Unidad,
   stock:Number(r["Stock Inicial"]||0),
   min:0,
   costo:Number(r["Costo Unitario"]||0),
   categoria:"INSUMOS"
  });
 });
}

function loadProductos(wb){
 const sh=wb.Sheets["precio"]; if(!sh) return;
 XLSX.utils.sheet_to_json(sh).forEach(r=>{
  DB.productos.push({nombre:r.Producto,precio:Number(r.Precio)});
 });
}

function loadRecetas(wb){
 const sh=wb.Sheets["receta"]; if(!sh) return;
 XLSX.utils.sheet_to_json(sh).forEach(r=>{
  DB.recetas.push({producto:r.Producto,insumo:r.Ingrediente,cantidad:Number(r.Cantidad)});
 });
}

function loadPacks(wb){
 const sh=wb.Sheets["pack"]; if(!sh) return;
 DB.packs=XLSX.utils.sheet_to_json(sh);
}

function loadProduccion(wb){
 const sh=wb.Sheets["produccion"]; if(!sh) return;
 XLSX.utils.sheet_to_json(sh).forEach(r=>{
  DB.produccion.push({fecha:r.Fecha,producto:r.Producto,cantidad:Number(r.Cantidad)});
  DB.recetas.filter(rc=>rc.producto===r.Producto).forEach(rc=>{
   const ins=DB.insumos.find(i=>i.nombre===rc.insumo);
   if(ins){
    const q=rc.cantidad*r.Cantidad;
    ins.stock-=q;
    DB.kardex.push({fecha:r.Fecha,tipo:"PRODUCCI√ìN",insumo:ins.nombre,cantidad:-q});
   }
  });
 });
}

// ======================= INIT =======================
dashboard();
</script>
</body>
</html>
